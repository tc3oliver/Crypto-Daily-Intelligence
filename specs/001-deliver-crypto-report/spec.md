# 功能規格：加密貨幣每日情報自動化

**功能分支**: `001-deliver-crypto-report`  
**建立日期**: 2025-11-05  
**狀態**: 草稿  
**輸入**: 使用者描述："根據 docs/SDD.md 和 docs/SRS.md 自動化加密貨幣每日市場報告管道"

## 澄清

### Session 2025-11-05

- Q: 應生成的報告與執行日誌是否可對外部公開存取？ → A: 僅限內部檔案系統存取。

## 使用者情境與測試 *(必填)*

<!--
  重要：使用者故事應按重要性排序為使用者旅程。
  每個使用者故事/旅程必須能獨立測試——這意味著即使只實現其中一個，
  也應該有一個可行的 MVP（最小可行產品）能提供價值。

  為每個故事分配優先級（P1、P2、P3 等），其中 P1 是最重要的。
  將每個故事視為一個獨立的功能片段，能夠：
  - 獨立開發
  - 獨立測試
  - 獨立部署
  - 獨立向使用者展示

  參考驗證證據（自動化 pytest 模組或煙霧測試命令 +
  生成的 `data/` 工件），以便審核者能追蹤與憲章的合規性。
-->

### 使用者故事 1 - 審查每日情報報告 (優先級: P1)

操作分析師需要一個指令來生成每日市場情報報告，以便在市場開盤前向利益相關者簡報。

**為何此優先級**: 每日報告是核心價值主張；沒有它，利益相關者將缺乏及時的加密貨幣洞察。

**獨立測試**: 在準備好的數據集上運行 `python scripts/run_daily.py --date 2025-11-04`；確認 `data/reports/2025-11-04.md` 存在，遵循模板部分，並且相應的 `data/logs/2025-11-05.run.log` 記錄每個階段並帶有 `[OK]` 標記。

**驗收情境**：

1. **假設** 有效的 Miniflux 訪問和 API 金鑰，**當** 操作者為目標日期運行管道時，**則** 管道生成指標、研究和 Markdown 報告，存儲在標準的 `data/<stage>/YYYY-MM-DD.*` 路徑下。
2. **假設** 管道完成，**當** 分析師打開生成的報告時，**則** 每個部分（市場概覽、主題、風險、情緒、觀察清單）都填充了數據，或者在來源缺失的情況下顯示 `N/A` 標記。

---

### 使用者故事 2 - 安全地重新運行失敗的階段 (優先級: P2)

值班工程師必須能夠在暫時性故障後，為特定日期重新運行任何單個階段（例如 `deepresearch.py`），而無需重新處理整個管道。

**為何此優先級**: 部分重新運行可減少外部 API 故障時的恢復時間，並保護下游數據的新鮮度。

**獨立測試**: 在分段 `data/topics/2025-11-04.json` 後執行 `python scripts/deepresearch.py --date 2025-11-04`；驗證 `data/research/2025-11-04.jsonl` 更新，並且運行日誌捕獲重新運行結果而不重複先前記錄。

**驗收情境**：

1. **假設** 部分完成的管道具有緩存的工件，**當** 工程師使用 `--date` 參數重新運行特定階段腳本時，**則** 腳本成功完成並僅覆蓋其階段工件，同時保持其他輸出不變。

---

### 使用者故事 3 - 審核主題洞察的準確性 (優先級: P3)

研究負責人抽查生成的主題摘要，以確保語氣、情緒和觀察清單與來源材料一致，然後再分發。

**為何此優先級**: 對衍生洞察進行質量保證可維持對自動摘要的信任，並防止錯誤信息。

**獨立測試**: 運行 `python scripts/deepresearch.py --date 2025-11-04` 生成 `data/research/2025-11-04.jsonl`，然後與存檔的來源數據進行差異比較，確認每個主題至少列出一個支持文章 URL，並且情緒分數在預期的 0-10 範圍內。

**驗收情境**：

1. **假設** 已生成的研究文件，**當** 負責人檢查任何主題條目時，**則** 摘要引用正確的主題 ID，包含影響分類、情緒分數、觀察符號和來源計數，並與 `data/topics/2025-11-04.json` 對應。

---

### 邊界情境

- 外部 API 在計劃窗口內返回空值或速率限制響應——系統在輸出中記錄 `N/A`，記錄警告，並允許數據恢復後重新運行。
- Miniflux 為某主題提供少於兩個條目——聚類仍需生成有效主題，並標記為“單篇文章”分類。
- LiteLLM 對某主題的聊天補全超時——管道記錄失敗，將主題標記為佔位符洞察，並繼續處理其餘主題。
- 磁碟寫入因空間不足失敗——管道顯示錯誤，中止剩餘階段，並保留現有工件而不損壞。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須在過去 24 小時內從 Miniflux 中攝取最多 300 條 RSS 條目，並將原始提要保存為 `data/raw/YYYY-MM-DD.jsonl`。
- **FR-002**: 系統必須將原始條目標準化（去重、清理 HTML、標準化時間戳），並轉換為 `data/normalized/YYYY-MM-DD.jsonl`，字段類型符合 SDD 架構。
- **FR-003**: 系統必須使用 LiteLLM 向量嵌入（相似度閾值 ≥ 0.82）對標準化條目進行聚類，並將主題元數據保存到 `data/topics/YYYY-MM-DD.json`。
- **FR-004**: 系統必須捕獲市場指標（BTC、ETH、總市值、衍生品、ETF 流量），並將其存儲為 `data/metrics/YYYY-MM-DD.json`，在 API 失敗時使用回退 `N/A` 值。
- **FR-005**: 系統必須生成研究洞察（`data/research/YYYY-MM-DD.jsonl`）和最終的 Markdown 報告（`data/reports/YYYY-MM-DD.md`），遵循 `config/report_prompt.md` 中記錄的部分順序。
- **FR-006**: 系統必須將每個階段執行記錄到 `data/logs/YYYY-MM-DD.run.log`，包括失敗時的 `[ERROR]` 條目和可追溯的時間戳。
- **FR-007**: 使用者必須能夠使用 `--date` 參數重新運行任何單個階段腳本，以重新生成該日期的工件，無需手動清理文件。

### 關鍵實體 *(如果功能涉及數據)*

- **RawFeedEntry**: 表示 Miniflux 文章，包含標識符、標題、正文文本、來源、發布時間戳和 URL。
- **NormalizedEntry**: 從 RawFeedEntry 派生的清理記錄；包括規範文本、時區標準化時間戳和去重標識符。
- **TopicCluster**: 聚合組，包含 topic_id、標題、代表文本、文章列表（標題、來源、URL）和項目計數。
- **ResearchInsight**: 每個主題的分析，包括摘要、影響標籤、情緒分數（0-10）、觀察符號、建議和來源計數。
- **MarketMetricsSnapshot**: 每日指標負載，包括價格、百分比變化、衍生品數據、ETF 流量和捕獲時間戳。
- **DailyMarketReport**: 最終的 Markdown 文檔，引用指標和洞察，結構化為固定部分供分析師使用。

### 非功能需求

- **NFR-CODE-QUALITY**: 解決方案必須保持模組小型化、類型化、格式化（`python -m black scripts`），並在適當時重用 `scripts/utils.py`。
- **NFR-TESTING**: 必須為新邏輯提供自動化 pytest 覆蓋；如果不可行，記錄煙霧測試命令和生成的 `data/` 工件。
- **NFR-UX**: 輸出必須保持命名/結構（`data/<stage>/YYYY-MM-DD.*`），並在用戶界面行為更改時更新文檔。
- **NFR-PERFORMANCE**: 捕獲預期的運行時間/內存預算、緩存/批處理策略，以及 15 分鐘每日 SLA 的接受閾值。
- **NFR-RESILIENCE**: 管道必須顯示可恢復的故障，並提供可操作的日誌消息，支持無需手動狀態重置的重新運行。
- **NFR-OBSERVABILITY**: 階段日誌必須包括持續時間指標（開始/完成時間戳），使操作員能夠發現回歸。
- **NFR-SECURITY**: 報告與執行日誌僅限內部檔案系統存取，透過作業系統權限避免外部分享或未授權下載。

## 成功標準 *(必填)*

### 可衡量的結果

- **SC-001**: ≥95% 的計劃每日運行在亞洲/台北時間 08:10 前完成，並將成功報告存儲在 `data/reports/` 下。
- **SC-002**: 完整管道運行時間保持在 15 分鐘以內，使用 2 vCPU / 4 GB RAM 主機，並記錄每個階段的持續時間以進行趨勢分析。
- **SC-003**: `data/topics/` 中至少 90% 的每日主題包含對應的研究洞察，情緒分數在 0 到 10 之間。
- **SC-004**: 分析師每週反饋中對生成報告的有用性評分 ≥4/5，並提到準確的指標和可操作的敘述。
- **SC-005**: 單個階段故障（例如重新嘗試 `deepresearch.py`）的恢復在 10 分鐘內完成，並在無需手動清理的情況下重新生成一致的工件。

## 假設

- Miniflux、LiteLLM 代理和外部市場數據 API 在計劃窗口內保持可訪問，並提供有效憑據。
- 歷史回填數據可用於乾運行驗證，支持針對已知日期（例如 `2025-11-04`）的確定性煙霧測試。
- 操作者在 `data/` 中維持至少 30 天的工件，以支持審計，符合憲章保留指南。

## 依賴項

- 參考架構和架構定義來自 `docs/SDD.md` 和 `docs/SRS.md`。
- 報告模板詳細信息來自 `config/report_prompt.md`。
- 憲章 v1.0.0 對代碼質量、測試紀律、用戶體驗一致性和性能保護的要求。
